# 要件定義書：画像顔モザイク処理ツール

## 1. プロジェクト概要

### 1.1 プロジェクト名
画像顔モザイク処理ツール（Face Mosaic Tool）

### 1.2 目的
ユーザーが任意の画像をアップロードし、ブラウザ上でリアルタイムに顔検出・エフェクト処理を行うWebアプリケーションを開発する。サーバーへの画像送信を一切行わず、プライバシーを保護したまま顔の匿名化処理を提供する。

### 1.3 背景
SNSやブログ等での画像公開時、第三者のプライバシー保護を目的として顔の匿名化処理が求められるケースが増加している。専用ソフトウェアのインストール不要で、ブラウザのみで完結する手軽なツールのニーズがある。

---

## 2. 対象ユーザー

- SNSやブログに写真を投稿するユーザー
- イベント・学校行事の写真を管理・公開する担当者
- プライバシーに配慮した画像を手軽に作成したいユーザー
- リテラシーレベル：一般的なWebブラウザ操作ができるユーザー（技術知識不要）

---

## 3. システム構成・技術方針

### 3.1 実行環境
- フロントエンドのみで完結するシングルページコンポーネント
- サーバーサイド処理なし
- Astroフレームワークの特定ページ内に `.astro` コンポーネントとして配置
- 対象ブラウザ：Chrome / Firefox / Safari / Edge（最新版）

### 3.2 使用技術

| 技術 | 用途 |
|------|------|
| Astro (.astro) | ページ・コンポーネント構成 |
| Vanilla JS (`<script>` タグ) | アプリロジック・UIインタラクション |
| CSS3 / Scoped Style | スタイリング（モダンデザイン） |
| OpenCV.js | 顔検出処理（Haar Cascade分類器） |
| Canvas API | 画像描画・エフェクト処理・手動矩形描画 |

### 3.3 Astro実装方針
- ロジックはすべて `.astro` ファイル内の `<script>` タグに Vanilla JS で記述する
- フレームワーク（React / Vue）は使用しない
- スタイルは `<style>` タグ内に記述し、スコープを活用してページ全体への影響を避ける
- OpenCV.js は CDN から非同期読み込みし、`is:inline` スクリプトで制御する

### 3.4 プライバシー原則
- **画像データはブラウザ外に送信しない**
- サーバーへのアップロード機能を持たない
- ローカルストレージ・Cookie等への画像保存も行わない
- UI上にプライバシー保護の旨を明示する

---

## 4. 機能要件

### 4.1 画像入力機能

#### FR-001：ファイル選択
- `<input type="file">` によるファイル選択ダイアログを提供する
- 対応フォーマット：JPEG / PNG / WebP / GIF（静止画）
- ファイルサイズ上限：20MB（超過時にエラーメッセージを表示）
- 複数ファイル選択は不可（1ファイルのみ）

#### FR-002：ドラッグ&ドロップ
- ドロップゾーン領域へのドラッグ&ドロップで画像を入力できる
- ドラッグオーバー中はドロップゾーンをハイライト表示する（枠線色の変化・背景色の変化）
- ファイル選択ボタンとドラッグ&ドロップは同一エリアに統合して表示する

#### FR-003：プレビュー表示
- 画像選択後、Canvas上に元画像をプレビュー表示する
- 表示サイズはコンテナ幅に合わせてアスペクト比を維持してリサイズする
- 内部処理（顔検出・エフェクト）は元解像度のまま行う

---

### 4.2 顔検出機能

#### FR-004：OpenCV.js 初期化
- ページロード時に OpenCV.js を CDN から非同期で読み込む
- 読み込み中はステータスバーに「OpenCV.js 読み込み中...」を表示する
- 読み込み完了後はステータスを「準備完了」に更新し、操作UIを有効化する
- 読み込み失敗時はエラーメッセージを表示し、リロードを促す

#### FR-005：Haar Cascade 顔検出
- `haarcascade_frontalface_default.xml` を使用した正面顔検出を実装する
- 検出後、検出された顔の矩形領域リストをメモリ上で管理する
- 検出結果はCanvasにオーバーレイ表示する（処理前確認用）

#### FR-006：検出パラメータの調整
- **minNeighbors**（検出感度）
  - 調整方法：スライダー + 現在値の数値表示
  - 範囲：1〜10（デフォルト：2）
  - 説明テキスト：「小さいほど多く検出（誤検出も増える）」
- **scaleFactor**（検出精度）
  - 調整方法：スライダー + 現在値の数値表示
  - 範囲：1.05〜2.0（デフォルト：1.1、ステップ：0.05）
  - 説明テキスト：「小さいほど精度高い（処理は遅くなる）」

---

### 4.3 エフェクト処理機能

#### FR-007：エフェクト種別の選択
以下のエフェクトをラジオボタンまたはトグルUIで排他選択できる。

| エフェクト名 | 処理内容 |
|------------|---------|
| モザイク | 顔領域をピクセル化（低解像度化）して再描画 |
| ぼかし | 顔領域にガウシアンぼかし（Gaussian Blur）を適用 |
| 黒塗り | 顔領域を黒色矩形で塗りつぶす |
| 枠線 | 顔領域に矩形の枠線を描画（確認・プレビュー用） |

#### FR-008：モザイク強度の調整（モザイク選択時）
- ピクセルサイズをスライダーで調整可能
- 範囲：5〜40px（デフォルト：15px）
- スライダー変更時にリアルタイムでCanvasを再描画する

#### FR-009：ぼかし強度の調整（ぼかし選択時）
- カーネルサイズをスライダーで調整可能
- 範囲：5〜51（奇数のみ、デフォルト：21）
- スライダー変更時にリアルタイムでCanvasを再描画する

#### FR-010：枠線設定（枠線選択時）
- 枠線の色をカラーピッカーで選択可能（デフォルト：`#ef4444`）
- 枠線の太さをスライダーで調整可能（1〜10px、デフォルト：3px）

---

### 4.4 手動矩形調整機能

#### FR-011：手動矩形の追加
- Canvasプレビュー上でマウス（またはタッチ）ドラッグにより任意の矩形を描画できる
- 描画モードと通常モードをトグルボタンで切り替える
- 描画した矩形は自動検出矩形と同様にエフェクトが適用される
- 手動追加した矩形は視覚的に区別できるよう色を変えてオーバーレイ表示する（例：青枠）

#### FR-012：矩形の個別削除
- Canvasプレビュー上の矩形をクリックして選択状態にできる
- 選択状態の矩形を「削除」ボタンまたは `Delete` キーで削除できる
- 削除後はCanvasを即時再描画する

#### FR-013：全矩形のリセット
- 「検出結果をリセット」ボタンで手動追加・自動検出を含む全矩形を削除する

---

### 4.5 処理実行・リセット機能

#### FR-014：顔検出の実行
- 「顔を検出」ボタンを押すと顔検出処理を実行する
- 処理中はボタンをdisabledにしてローディングスピナーを表示する
- 完了後「N個の顔を検出しました」とステータスに表示する

#### FR-015：エフェクト適用
- エフェクト種別・強度の変更はリアルタイムでCanvasに反映する
- 明示的な「適用」ボタンは不要（自動更新）

#### FR-016：全体リセット
- 「リセット」ボタンで元画像・検出結果・設定値をすべて初期状態に戻す

---

### 4.6 画像出力機能

#### FR-017：画像のダウンロード
- 「画像を保存」ボタンでエフェクト適用済み画像をダウンロードする
- ファイル形式：PNG
- ファイル名：`face-mosaic_[元ファイル名].png`
- 解像度：元画像と同解像度で出力する
- 画像未選択・未処理時はボタンをdisabled状態にする

---

## 5. 非機能要件

### 5.1 パフォーマンス
- 1200×900px程度の一般的な写真で顔検出処理が5秒以内に完了すること
- エフェクト強度のスライダー操作はデバウンス処理（100〜200ms）を入れて描画負荷を軽減する
- OpenCV.jsのロード中はUIをブロックせず、ステータスで状態を明示する

### 5.2 デザイン・UX
- モダンで洗練されたUIデザインを採用する（角丸・シャドウ・グラデーション等を活用）
- カラーテーマ：ダークまたはニュートラルトーンをベースにアクセントカラーを使用
- 操作の流れが直感的になるよう、ステップ順（① 画像選択 → ② 検出設定 → ③ エフェクト選択 → ④ 保存）にUIを縦配置する
- スマートフォン・タブレットでも使用可能なレスポンシブレイアウトとする
- ホバー・フォーカス時のフィードバック（トランジション）を適切に実装する

### 5.3 アクセシビリティ
- フォームコントロールには適切な `<label>` を付与する
- キーボード操作で主要機能（選択・実行・削除）を利用可能にする
- コントラスト比はWCAG 2.1 AA基準を満たす

### 5.4 セキュリティ
- 外部リソースの読み込みはOpenCV.js CDNのみとし、Subresource Integrity（SRI）の適用を検討する
- ユーザーの画像データはメモリ上でのみ扱い、ページを閉じれば消去される

### 5.5 Astro固有の考慮事項
- `<script>` タグは `is:inline` または通常の `<script>` を用途に応じて使い分ける
- OpenCV.jsの読み込みはページの `onload` または `DOMContentLoaded` タイミングで実施する
- Astroのビルド時にスクリプトがバンドルされてもOpenCV.jsの動的ロードが正常に機能することを確認する
- CSSスコープ（`<style>`）を活用し、サイト全体への副作用を防ぐ

---

## 6. 画面仕様

### 6.1 ページレイアウト（デスクトップ）

```
┌─────────────────────────────────────────────────┐
│  ステップ① 画像を選択                             │
│  ┌───────────────────────────────────────────┐  │
│  │  ドラッグ&ドロップ / ファイル選択ゾーン    │  │
│  └───────────────────────────────────────────┘  │
├─────────────────────────────────────────────────┤
│  ステップ② 顔を検出                              │
│  minNeighbors: [スライダー] 2                    │
│  scaleFactor:  [スライダー] 1.1                  │
│  [　　顔を検出　　]  ステータス: 3個検出          │
├──────────────────────┬──────────────────────────┤
│  ステップ③ エフェクト │  Canvasプレビュー         │
│  ○ モザイク          │                          │
│  ○ ぼかし            │   （処理済み画像表示）    │
│  ○ 黒塗り            │                          │
│  ○ 枠線              │                          │
│  強度: [スライダー]   │                          │
│  [描画モード切替]     │                          │
├──────────────────────┴──────────────────────────┤
│  ステップ④  [　画像を保存　]   [　リセット　]     │
└─────────────────────────────────────────────────┘
```

### 6.2 モバイルレイアウト
- 全セクションを縦1カラムで配置する
- Canvasはコンテナ幅100%でアスペクト比を維持して表示する
- スライダーはタップ操作がしやすい高さ（44px以上）を確保する

---

## 7. エラーハンドリング

| シナリオ | 表示メッセージ |
|---------|--------------|
| 非対応フォーマットのファイル | 「対応フォーマット（JPEG / PNG / WebP）の画像を選択してください」 |
| ファイルサイズ超過（20MB以上） | 「ファイルサイズが上限（20MB）を超えています」 |
| OpenCV.js 読み込み失敗 | 「OpenCV.jsの読み込みに失敗しました。ページを再読み込みしてください」 |
| 顔が検出されなかった | 「顔が検出されませんでした。minNeighborsを下げて再試行してください」 |
| 画像未選択で処理実行 | 「先に画像を選択してください」 |
| 処理中の予期せぬエラー | 「処理中にエラーが発生しました。ページを再読み込みして再試行してください」 |

---

## 8. ファイル構成（Astro想定）

```
src/
├── pages/
│   └── tools/
│       └── face-mosaic.astro       # ページファイル（レイアウト・UI）
├── components/
│   └── tools/
│       └── FaceMosaic.astro        # 顔モザイクコンポーネント本体
└── styles/
    └── face-mosaic.css             # （任意）スタイル分離する場合
```

- ロジックはすべて `FaceMosaic.astro` の `<script>` タグ内に Vanilla JS で記述する
- OpenCV.js は `<script>` タグの `src` 属性で CDN から読み込む
- Haar Cascade XML は OpenCV.js の `createFileFromUrl` でロードする

---

## 9. 制約・前提条件

- OpenCV.js は CDN（`https://docs.opencv.org/4.x/opencv.js`）から読み込む
- 顔検出は正面顔のみ対応（横向き・後ろ向きは検出精度が低い）
- GIFアニメーションは静止画（1フレーム目）として処理する
- 極端に大きな画像（8000px以上）は処理が著しく遅くなる場合がある
- Astroの `client:*` ディレクティブは使用しない（Vanilla JS のみ）

---

## 10. 将来的な拡張候補（スコープ外）

- 動画ファイル・カメラ映像（WebRTC）のリアルタイム処理
- 横顔・下向き顔の検出（追加Haar Cascade）
- 手動矩形のサイズ・位置のドラッグ調整
- 複数画像の一括処理
- ダークモード / ライトモード切り替え